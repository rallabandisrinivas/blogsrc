---
title: Oracle备份脚本
date: 2018-07-30 12:12:28
tags:
- Linux
- db
- Oracle

---

### 1. Oracle概览
- 数据库
数据库有别于`MySQL`中的数据库概念，一个操作系统只有一个数据库，数据库是数据文件，控制文件，联机日志等的集合。
- 实例
一个数据库可以存在多个实例，只有通过实例才可以操作数据库
- 用户
用户是在实例下创建的，不同实例可以相同的用户
- 表空间
管理数据的存储逻辑概念，一个表空间包含多个数据文件，一个数据文件只能属于一个表空间
- 数据文件
数据存储在表空间中，实际上是存在于某个或者多个数据文件中。如果要删除某个数据文件，只能删除该数据文件所属的表空间。
<!-- more -->
- 综合
![enter image description here](http://img.blog.csdn.net/20131217110014406)
用户把表中的数据放入某一个表空间，表空间和用户没有绑定关系，表空间会将这些数据放到放到一个或者多个数据文件中。表空间仅仅是来存放数据，查询数据由用户来进行的。不同用户可以在同一表空间内存放数据。
Oracle数据库可以创建多个实例，每个实例可以创建多个表空间，每个空间可以被多个用户授权访问，每个用户可以创建多个表（每个表被表空间随机存储在一个或多个数据库文件中）。


### 2. 环境变量查看
- 查看文件安装位置
可以通过`service`文件来查看安装路径

- 查看环境变量
```bash
cat /master/ora11g/app/oracle/product/11.2.0/dbhome_1/network/admin/listener.ora
# listener.ora Network Configuration File: /master/ora11g/app/oracle/product/11.2.0/dbhome_1/network/admin/listener.ora
# Generated by Oracle configuration tools.
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = dongdongdb)
      (ORACLE_HOME = /master/ora11g/app/oracle/product/11.2.0/dbhome_1)
      (SID_NAME = dongdong)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = 22.123.1.141)(PORT = 1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = 122.114.5.164)(PORT = 1521))
    )
  )

ADR_BASE_LISTENER = /master/ora11g/app/oracle

```

- 设定下面几个环境变量
```bash
export USER=oracle;
export ORACLE_SID=dongdong;
export ORACLE_BASE=/master/ora11g/app;
export ORACLE_HOME=/master/ora11g/app/oracle/product/11.2.0/dbhome_1;
export PATH=$ORACLE_HOME/bin:$PATH;
```
- 整合脚本
最好加上权限`chown -R oracle oracle-bak.sh`


```bash
#! /usr/bin

#dir setup
FILEPATH=/master/backup
FILENAME=$(date +%Y%m%d-%H:%M)
[ ! -d $FILEPATH ] && mkdir $FILEPATH
cd $FILEPATH
mkdir $FILENAME
chmod 775 $FILENAME

#oracle env

export ORACLE_SID=dongdong;
export ORACLE_BASE=/master/ora11g/app;
export ORACLE_HOME=/master/ora11g/app/oracle/product/11.2.0/dbhome_1;
export PATH=$ORACLE_HOME/bin:$PATH;

#go exp
exp ZRZL/ZRZL\$PRD2017 owner=ZRZL rows=y indexes=n compress=n file="$FILENAME/$FILENAME".dmp log="$FILENAME/$FILENAME".log

#go imp
#imp ZRZL/ZRZL\$PRD2017 fromuser=ZRZL touser=ZRZL file="$FILENAME/$FILENAME".dmp

#tar files
tar -zcvf $FILENAME.tar.gz $FILENAME
if [[ $? -eq 0 ]];then
	rm -rf $FILENAME
fi

#after 30 days ago delete them 
find $FILEPATH -type f -mtime +29 -name "*.tar.gz" -exec rm {} \;


#after 30 days ago delete dir
find /master/backup -type d -mtime +29 -name "2018*" -exec rm -rf {} \;

```

- 定时任务
```bash
echo "00 02 * * * /usr/bin/sh /root/.shell/oracle-bak.sh > /dev/null 2>&1" >>  /var/spool/cron/root 
service crond restart
 
```

### 数据库文件

```bash
#数据文件
D:\ORACLE\PRODUCT\22.1.0\ORADATA\ORCL\SYSTEM01.DBF
#控文件
D:\ORACLE\PRODUCT\22.1.0\ORADATA\ORCL\CONTROL01.CTL
#日志文件
D:\ORACLE\PRODUCT\22.1.0\ORADATA\ORCL\REDO03.LOG
```

